## HotSpot对象创建

new关键字的作用

- 1.类加载检查
- 2.分配内存
- 3.初始化零值
- 4.设置对象头
- 执行 init 方法

###类加载检查
虚拟机遇到一条 new 指令时，首先将去检查这个指令的参数是否能在常量池中定位到这个类的符号引用，并且检查这个符号引用代表的类是否已被加载过、解析和初始化过。如果没有，那必须先执行相应的类加载过程。

###分配内存
在**类加载检查**通过后，接下来虚拟机将为新生对象**分配内存**。对象所需的内存大小在类加载完成后便可确定，为对象分配空间的任务等同于把一块确定大小的内存从 Java 堆中划分出来。

**分配方式**有 **“指针碰撞”** 和 **“空闲列表”** 两种，**选择那种分配方式由 Java 堆是否规整决定，而 Java 堆是否规整又由所采用的垃圾收集器是否带有压缩整理功能决定**。

1.**内存区域规整**使用**指针碰撞**：在内存区域中，已使用与未使用的内存空间中有一条明确的分界线，只要将位于分界线的指针移动对象大小的距离就可以分配内存。

2.**内存区域不规整**使用**空闲列表**：在堆内存中额外维护一份可用内存的列表，当新内存分配时，到空闲列表中确定足够大小的空间进行分配。

**分配时存在的并发问题解决：**

- 1.CAS失败重试 ：
   - CAS 是乐观锁的一种实现方式。所谓乐观锁就是，每次不加锁而是假设没有冲突而去完成某项操作，如果因为冲突失败就重试，直到成功为止。**虚拟机采用 CAS 配上失败重试的方式保证更新操作的原子性。**
- 2.TLAB：
   -  为每一个线程预先在 Eden 区域分配一块内存，这块内存叫 TLAB ，分配内存时首先在TLAB中分配，当TLAB不足时，进行CAS失败重试方式进行分配。


###初始化零值
内存分配完成后，虚拟机需要将分配到的内存空间都初始化为零值（不包括对象头），**这一步操作保证了对象的实例字段在 Java 代码中可以不赋初始值就直接使用，**程序能访问到这些字段的数据类型所对应的零值。

###设置对象头
初始化零值完成之后，**虚拟机要对对象进行必要的设置**，例如这个对象是那个类的实例、如何才能找到类的元数据信息、对象的哈希码、对象的 GC 分代年龄等信息。 **这些信息存放在对象头中。** 另外，根据虚拟机当前运行状态的不同，如是否启用偏向锁等，对象头会有不同的设置方式。

扩展：**对象在内存中的布局**(对象大小为8n, n正整数)

- 对象头：两部分
   - 1.存储自身运行时数据：hash码，GC分代年龄，锁状态标志等等
   - 2.类型指针：对象指向他类元数据的指针
- 实例数据：对象存储的有效数据
- 对齐填充：非必然存在，无意义

问：**为什么长度是8n?**

- 引用类型的内存占用和**系统位数及启动参数UseCompressedOops有关**。32位系统占4字节，64位系统开启UseCompressedOops时占用4字节，否则就是8字节。**在Hotspot中，为了更加容易的管理内存，一般会使用8字节进行对齐。意思是每次分配的内存大小一定是8的倍数，如果对象头+实例数据的值不是8的倍数，那么会重新计算一个较大值，进行分配。**

###执行init方法
在上面工作都完成之后，从虚拟机的视角来看，一个新的对象已经产生了，但从 Java 程序的视角来看，对象创建才刚开始，`<init>` 方法还没有执行，所有的字段都还为零。所以一般来说，执行 new 指令之后会接着执行 `<init>` 方法，把对象按照程序员的意愿进行初始化，这样一个真正可用的对象才算完全产生出来。


##对象访问定位
建立对象就是为了使用对象，我们的 Java 程序通过栈上的 reference 数据来操作堆上的具体对象。对象的访问方式有虚拟机实现而定，目前主流的访问方式有**①使用句柄**和**②直接指针**两种，具体如何使用由JVM自己选择：

1. **句柄：** 如果使用句柄的话，那么 Java 堆中将会划分出一块内存来作为句柄池，reference 中存储的就是对象的句柄地址，而句柄中包含了对象实例数据与类型数据各自的具体地址信息；

  ![对象的访问定位-使用句柄](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/对象的访问定位-使用句柄.png)

2. **直接指针：**  如果使用直接指针访问，那么 Java 堆对象的布局中就必须考虑如何放置访问类型数据的相关信息，而 reference 中存储的直接就是对象的地址。

![对象的访问定位-直接指针](https://my-blog-to-use.oss-cn-beijing.aliyuncs.com/2019-6/对象的访问定位-直接指针.png)

**这两种对象访问方式各有优势。使用句柄来访问的最大好处是 reference 中存储的是稳定的句柄地址，在对象被移动时只会改变句柄中的实例数据指针，而 reference 本身不需要修改。使用直接指针访问方式最大的好处就是速度快，它节省了一次指针定位的时间开销。**



